<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Videollamadas Jitsi - TutorMatch</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: 90vh;
        }

        .video-call-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .controls-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .header {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .controls {
            margin-bottom: 20px;
        }

        .controls h3 {
            margin-top: 0;
            color: #333;
        }

        .control-group {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .control-group h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.2s;
        }

        .button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .button.primary {
            background-color: #007bff;
            color: white;
        }

        .button.primary:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .button.success {
            background-color: #28a745;
            color: white;
        }

        .button.success:hover:not(:disabled) {
            background-color: #218838;
        }

        .button.danger {
            background-color: #dc3545;
            color: white;
        }

        .button.danger:hover:not(:disabled) {
            background-color: #c82333;
        }

        .button.secondary {
            background-color: #6c757d;
            color: white;
        }

        .button.secondary:hover:not(:disabled) {
            background-color: #545b62;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }

        .input-group label {
            font-weight: bold;
            color: #495057;
        }

        .input-group input,
        .input-group select {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        #jitsi-container {
            flex: 1;
            min-height: 500px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #6c757d;
        }

        .call-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .call-info h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .call-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        .status-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-scheduled {
            background: #fff3cd;
            color: #856404;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-ended {
            background: #f8d7da;
            color: #721c24;
        }

        .my-calls-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }

        .call-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .call-item:hover {
            background-color: #f8f9fa;
        }

        .call-item:last-child {
            border-bottom: none;
        }

        .call-item h5 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .call-item p {
            margin: 2px 0;
            font-size: 12px;
            color: #666;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <h1>🎥 Test Videollamadas Jitsi - TutorMatch</h1>

    <div class="container">
        <!-- Panel de videollamada -->
        <div class="video-call-panel">
            <div class="header">
                <h2 id="panel-title">Videollamadas con Jitsi Meet</h2>
                <div id="user-info">Selecciona un usuario para comenzar</div>
            </div>

            <div id="error-container"></div>
            <div id="success-container"></div>

            <div id="jitsi-container">
                Selecciona un usuario y crea o únete a una videollamada para comenzar
            </div>

            <div id="call-info-container"></div>
        </div>

        <!-- Panel de controles -->
        <div class="controls-panel">
            <div class="controls">
                <h3>🔧 Configuración</h3>

                <!-- Selección de usuario -->
                <div class="control-group">
                    <h4>👤 Seleccionar Usuario</h4>
                    <button class="button primary" onclick="selectUser('u202213646@upc.edu.pe', 'Rodrigo Salvador')">
                        👤 Soy Rodrigo Salvador
                    </button>
                    <button class="button primary" onclick="selectUser('u202212338@upc.edu.pe', 'Rodrigo Lopez')">
                        👤 Soy Rodrigo Lopez
                    </button>
                </div>

                <!-- Crear videollamada -->
                <div class="control-group" id="create-call-group" style="display: none;">
                    <h4>🎥 Crear Videollamada</h4>
                    <div class="input-group">
                        <label>Nombre de la sala (opcional):</label>
                        <input type="text" id="room-name-input" placeholder="tutoring-session-123">
                    </div>
                    <button class="button success" onclick="createCall()" id="create-call-btn">
                        🎥 Crear Nueva Videollamada
                    </button>
                </div>

                <!-- Unirse a videollamada -->
                <div class="control-group" id="join-call-group" style="display: none;">
                    <h4>➕ Unirse a Videollamada</h4>
                    <div class="input-group">
                        <label>ID de la videollamada:</label>
                        <input type="text" id="call-id-input" placeholder="Pega el ID aquí">
                    </div>
                    <button class="button primary" onclick="joinCallById()" id="join-call-btn">
                        ➕ Unirse por ID
                    </button>
                    <button class="button success" onclick="showActiveCalls()" id="show-active-btn">
                        📡 Ver Salas Activas
                    </button>
                    <div id="active-calls-list" class="my-calls-list" style="display: none; margin-top: 10px;">
                        <p>Cargando salas activas...</p>
                    </div>
                </div>

                <!-- Controles de videollamada activa -->
                <div class="control-group" id="active-call-controls" style="display: none;">
                    <h4>🎮 Controles de Videollamada</h4>
                    <button class="button success" onclick="copyCallId()" id="copy-id-btn">
                        � Copiar ID para Compartir
                    </button>
                    <button class="button primary" onclick="toggleAudio()">
                        🎤 Toggle Audio
                    </button>
                    <button class="button primary" onclick="toggleVideo()">
                        📹 Toggle Video
                    </button>
                    <button class="button secondary" onclick="leaveCall()">
                        � Salir
                    </button>
                    <button class="button danger" onclick="endCall()">
                        ⏹️ Finalizar Videollamada
                    </button>
                </div>

                <!-- Mis videollamadas -->
                <div class="control-group" id="my-calls-group" style="display: none;">
                    <h4>📋 Mis Videollamadas</h4>
                    <button class="button success" onclick="loadMyCalls()">
                        🔄 Actualizar Lista
                    </button>
                    <div id="my-calls-list" class="my-calls-list">
                        <p>Carga tu lista de videollamadas...</p>
                    </div>
                </div>

                <!-- Otras opciones -->
                <div class="control-group">
                    <h4>🛠️ Otras Opciones</h4>
                    <button class="button secondary" onclick="getActiveCalls()">
                        📡 Ver Videollamadas Activas
                    </button>
                    <button class="button secondary" onclick="disconnect()">
                        🚪 Desconectar Usuario
                    </button>
                </div>
            </div>

            <!-- Información de debug -->
            <div class="control-group">
                <h4>🔧 Debug Info</h4>
                <div id="debug-info" style="font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                    <strong>Usuario:</strong> <span id="debug-user">-</span><br>
                    <strong>Token:</strong> <span id="debug-token">-</span><br>
                    <strong>Videollamada:</strong> <span id="debug-call">-</span><br>
                    <strong>Estado:</strong> <span id="debug-status">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración
        const CLASSROOM_API = 'http://localhost:3002';
        const SUPABASE_URL = 'https://xdqnuesrahrusfnxcwvm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkcW51ZXNyYWhydXNmbnhjd3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1OTk3NjAsImV4cCI6MjA2MDE3NTc2MH0.g9-gdoeMUw60904DqQRqI2VI97MPVmAkvwCuoAH7ToA';

        // Estado global
        let currentUser = {
            supabase: null,
            token: null,
            userId: null,
            email: null,
            name: null
        };
        let currentCall = null;
        let jitsiApi = null;
        let isLoading = false;

        // Cargar Supabase
        if (typeof supabase === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@supabase/supabase-js@2';
            document.head.appendChild(script);
        }

        // Seleccionar usuario
        async function selectUser(email, name) {
            showLoading('Autenticando usuario...');
            
            currentUser.email = email;
            currentUser.name = name;
            
            // Actualizar UI
            document.getElementById('user-info').textContent = `${name} (${email})`;
            document.getElementById('debug-user').textContent = `${name} (${email})`;
            
            // Autenticar
            await authenticate(email, name);
        }

        // Autenticar usuario
        async function authenticate(email, name) {
            try {
                // Crear cliente Supabase
                currentUser.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // Intentar login primero
                let { data, error } = await currentUser.supabase.auth.signInWithPassword({
                    email: email,
                    password: 'NUEVACUENTA'
                });

                // Si no existe, crear usuario
                if (error && error.message.includes('Invalid login credentials')) {
                    console.log(`🔄 Creando usuario ${name}...`);

                    const { data: signUpData, error: signUpError } = await currentUser.supabase.auth.signUp({
                        email: email,
                        password: 'NUEVACUENTA'
                    });

                    if (signUpError) {
                        throw signUpError;
                    }

                    console.log(`✅ Usuario ${name} creado, intentando login...`);

                    // Intentar login de nuevo
                    ({ data, error } = await currentUser.supabase.auth.signInWithPassword({
                        email: email,
                        password: 'NUEVACUENTA'
                    }));
                }

                if (error) {
                    throw error;
                }

                if (!data.session) {
                    throw new Error('No se pudo obtener la sesión de autenticación');
                }

                currentUser.token = data.session.access_token;
                currentUser.userId = data.user.id;

                showSuccess(`✅ ${name} autenticado correctamente`);
                updateDebugInfo();
                
                // Mostrar controles
                showUserControls();

                console.log(`✅ ${name} autenticado exitosamente:`, {
                    userId: data.user.id,
                    email: data.user.email
                });

            } catch (error) {
                console.error(`❌ Error autenticando ${name}:`, error);
                showError(`❌ Error autenticando: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Crear nueva videollamada
        async function createCall() {
            if (!currentUser.token) {
                showError('Primero selecciona y autentica un usuario');
                return;
            }

            const roomNameInput = document.getElementById('room-name-input');
            const roomName = roomNameInput.value.trim() || 
                `tutoring-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

            showLoading('Creando videollamada...');

            try {
                const response = await fetch(`${CLASSROOM_API}/video-calls`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({
                        jitsiRoomName: roomName
                        // NO enviamos scheduledFor para que sea activa inmediatamente
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                currentCall = data;
                
                showSuccess(`✅ ¡Sala ACTIVA creada! Nombre: ${data.jitsi_room_name} | ID: ${data.id} | Comparte este ID para que otros se unan`);
                updateCallInfo(data);
                initializeJitsi(data.jitsiConfig);
                showActiveCallControls();

            } catch (error) {
                console.error('Error creando videollamada:', error);
                showError(`❌ Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Unirse a videollamada por ID
        async function joinCallById() {
            if (!currentUser.token) {
                showError('Primero selecciona y autentica un usuario');
                return;
            }

            const callIdInput = document.getElementById('call-id-input');
            const callId = callIdInput.value.trim();

            if (!callId) {
                showError('Por favor ingresa el ID de la videollamada');
                return;
            }

            showLoading('Uniéndose a videollamada...');

            try {
                const response = await fetch(`${CLASSROOM_API}/video-calls/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({ callId })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                currentCall = data;
                
                showSuccess(`✅ Te uniste a la videollamada: ${data.jitsi_room_name}`);
                updateCallInfo(data);
                initializeJitsi(data.jitsiConfig);
                showActiveCallControls();

            } catch (error) {
                console.error('Error uniéndose a videollamada:', error);
                showError(`❌ Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Variables de estado para evitar llamadas duplicadas
        let isLeavingCall = false;
        let hasJoinedSuccessfully = false;

        // Salir de videollamada
        async function leaveCall(isAutomatic = false) {
            if (isLeavingCall) {
                console.log('🔄 Ya está en proceso de salir de la videollamada');
                return;
            }

            if (!currentCall?.id) {
                if (!isAutomatic) {
                    showError('No estás en una videollamada');
                }
                return;
            }

            isLeavingCall = true;

            try {
                // Solo hacer la llamada al backend si realmente nos habíamos unido exitosamente
                if (hasJoinedSuccessfully || !isAutomatic) {
                    const response = await fetch(`${CLASSROOM_API}/video-calls/${currentCall.id}/leave`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${currentUser.token}`
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (!isAutomatic) {
                            showSuccess(`✅ ${result.message}`);
                        }
                    } else {
                        // No mostrar error si es automático y falla (común al aceptar permisos)
                        if (!isAutomatic) {
                            const errorText = await response.text();
                            console.warn('Error al salir del backend:', errorText);
                            showError(`⚠️ Error al notificar salida: ${errorText}`);
                        }
                    }
                }
            } catch (error) {
                console.error('Error saliendo de videollamada:', error);
                if (!isAutomatic) {
                    showError(`❌ Error de conexión: ${error.message}`);
                }
            }

            // Limpiar estado siempre
            if (jitsiApi) {
                try {
                    jitsiApi.dispose();
                } catch (error) {
                    console.warn('Error disposing Jitsi API:', error);
                }
                jitsiApi = null;
            }
            currentCall = null;
            isLeavingCall = false;
            hasJoinedSuccessfully = false;
            clearCallInfo();
            showUserControls();
            updateDebugInfo();
        }

        // Finalizar videollamada
        async function endCall() {
            if (!currentCall?.id) {
                showError('No estás en una videollamada');
                return;
            }

            try {
                await fetch(`${CLASSROOM_API}/video-calls/${currentCall.id}/end`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({
                        callId: currentCall.id
                    })
                });

                showSuccess('✅ Videollamada finalizada correctamente');
                await leaveCall(false);
            } catch (error) {
                console.error('Error finalizando videollamada:', error);
                showError(`❌ Error: ${error.message}`);
            }
        }

        // Cargar mis videollamadas
        async function loadMyCalls() {
            if (!currentUser.token) {
                showError('Primero autentica un usuario');
                return;
            }

            try {
                const response = await fetch(`${CLASSROOM_API}/video-calls/my-calls`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });

                if (response.ok) {
                    const calls = await response.json();
                    displayMyCalls(calls);
                    showSuccess(`✅ Cargadas ${calls.length} videollamadas`);
                } else {
                    throw new Error('Error cargando videollamadas');
                }
            } catch (error) {
                console.error('Error obteniendo videollamadas:', error);
                showError(`❌ Error: ${error.message}`);
            }
        }

        // Obtener videollamadas activas
        async function getActiveCalls() {
            try {
                const response = await fetch(`${CLASSROOM_API}/video-calls/active`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });

                if (response.ok) {
                    const activeCalls = await response.json();
                    console.log('Videollamadas activas:', activeCalls);
                    showSuccess(`✅ ${activeCalls.length} videollamadas activas encontradas (ver consola)`);
                    return activeCalls;
                } else {
                    throw new Error('Error obteniendo videollamadas activas');
                }
            } catch (error) {
                console.error('Error:', error);
                showError(`❌ Error: ${error.message}`);
                return [];
            }
        }

        // Mostrar salas activas para unirse
        async function showActiveCalls() {
            if (!currentUser.token) {
                showError('Primero autentica un usuario');
                return;
            }

            const container = document.getElementById('active-calls-list');
            container.style.display = 'block';
            container.innerHTML = '<p><span class="loading"></span>Cargando salas activas...</p>';

            try {
                const activeCalls = await getActiveCalls();
                displayActiveCalls(activeCalls);
            } catch (error) {
                container.innerHTML = '<p>Error cargando salas activas</p>';
            }
        }

        // Mostrar lista de salas activas
        function displayActiveCalls(calls) {
            const container = document.getElementById('active-calls-list');
            
            if (calls.length === 0) {
                container.innerHTML = '<p>🔍 No hay salas activas disponibles</p>';
                return;
            }

            container.innerHTML = `
                <p><strong>🎥 Salas Activas (${calls.length}):</strong></p>
                ${calls.map(call => `
                    <div class="call-item" onclick="joinActiveCall('${call.id}', '${call.jitsi_room_name}')" style="cursor: pointer; border: 1px solid #007bff; margin: 5px 0;">
                        <h5>🎥 ${call.jitsi_room_name}</h5>
                        <p><strong>ID:</strong> ${call.id}</p>
                        <p><strong>Estado:</strong> <span class="status-indicator status-active">${call.status}</span></p>
                        <p><strong>Creada:</strong> ${new Date(call.created_at).toLocaleString()}</p>
                        <p style="color: #007bff; font-weight: bold;">👆 Clic para unirse</p>
                    </div>
                `).join('')}
            `;
        }

        // Unirse a una sala activa específica
        async function joinActiveCall(callId, roomName) {
            if (!currentUser.token) {
                showError('Primero autentica un usuario');
                return;
            }

            // Llenar el input con el ID y unirse
            document.getElementById('call-id-input').value = callId;
            showSuccess(`🎯 Uniéndose a: ${roomName}`);
            await joinCallById();
        }

        // Controles de Jitsi
        function toggleAudio() {
            if (jitsiApi) {
                jitsiApi.executeCommand('toggleAudio');
            }
        }

        function toggleVideo() {
            if (jitsiApi) {
                jitsiApi.executeCommand('toggleVideo');
            }
        }

        // Copiar ID de videollamada al portapapeles
        async function copyCallId() {
            if (!currentCall?.id) {
                showError('No hay videollamada activa');
                return;
            }

            try {
                await navigator.clipboard.writeText(currentCall.id);
                showSuccess(`📋 ID copiado: ${currentCall.id} | Comparte este ID para que otros se unan`);
            } catch (error) {
                // Fallback para navegadores que no soportan clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = currentCall.id;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showSuccess(`📋 ID copiado: ${currentCall.id} | Comparte este ID para que otros se unan`);
                } catch (fallbackError) {
                    showError('No se pudo copiar al portapapeles');
                }
                document.body.removeChild(textArea);
            }
        }

        // Inicializar Jitsi Meet
        function initializeJitsi(config) {
            if (!window.JitsiMeetExternalAPI) {
                showError('Jitsi Meet API no está disponible');
                return;
            }

            try {
                const container = document.getElementById('jitsi-container');
                container.innerHTML = '';

                // Configuración mejorada para auto-join
                const jitsiOptions = {
                    roomName: config.roomName,
                    width: '100%',
                    height: 500,
                    parentNode: container,
                    configOverwrite: {
                        // ¡CLAVE! Configuraciones para auto-join directo
                        prejoinPageEnabled: false,        // No mostrar página de pre-unión
                        enableWelcomePage: false,         // No mostrar página de bienvenida
                        enableClosePage: false,           // No mostrar página de cierre
                        disableInitialGUM: false,         // Permitir acceso a cámara/micrófono
                        autoJoinDisabled: false,          // Habilitar auto-join
                        
                        // Configuración de medios - CAMBIO: Empezar silenciado para evitar problemas
                        startWithAudioMuted: true,        // Audio silenciado inicialmente
                        startWithVideoMuted: true,        // Video desactivado inicialmente
                        disableModeratorIndicator: false,
                        startScreenSharing: false,
                        enableEmailInStats: false,
                        startAudioOnly: false,
                        
                        // Configuración de calidad
                        resolution: 720,
                        constraints: {
                            video: {
                                aspectRatio: 16 / 9,
                                height: {
                                    ideal: 720,
                                    max: 1080,
                                    min: 240
                                }
                            }
                        },
                        
                        // Configuración de red
                        p2p: {
                            enabled: true,
                            preferH264: true
                        },
                        
                        // Configuración adicional para mejor UX
                        disableThirdPartyRequests: false,
                        enableNoAudioDetection: true,
                        enableNoisyMicDetection: true,
                        enableLipSync: true
                    },
                    interfaceConfigOverwrite: {
                        TOOLBAR_BUTTONS: [
                            'microphone', 'camera', 'closedcaptions', 'desktop',
                            'chat', 'raisehand', 'videoquality', 'filmstrip',
                            'feedback', 'stats', 'shortcuts', 'tileview',
                            'videobackgroundblur', 'help'
                        ],
                        SETTINGS_SECTIONS: ['devices', 'language', 'profile'],
                        
                        // Branding
                        SHOW_JITSI_WATERMARK: false,
                        SHOW_WATERMARK_FOR_GUESTS: false,
                        SHOW_BRAND_WATERMARK: false,
                        SHOW_POWERED_BY: false,
                        SHOW_PROMOTIONAL_CLOSE_PAGE: false,
                        
                        // UX mejorado
                        LANG_DETECTION: true,
                        CONNECTION_INDICATOR_DISABLED: false,
                        VIDEO_QUALITY_LABEL_DISABLED: false,
                        RECENT_LIST_ENABLED: false,
                        DISABLE_JOIN_LEAVE_NOTIFICATIONS: false,
                        MOBILE_APP_PROMO: false,
                        ENFORCE_NOTIFICATION_AUTO_DISMISS_TIMEOUT: 5000,
                        
                        // Configuración adicional
                        APP_NAME: 'TutorMatch',
                        NATIVE_APP_NAME: 'TutorMatch',
                        DEFAULT_BACKGROUND: '#007bff'
                    },
                    userInfo: {
                        displayName: currentUser.name,
                        email: `${currentUser.userId}@tutormatch.com`
                    }
                };

                jitsiApi = new JitsiMeetExternalAPI(config.domain, jitsiOptions);

                // Event listeners mejorados
                jitsiApi.addEventListener('videoConferenceJoined', (event) => {
                    console.log('✅ Te uniste exitosamente a la videollamada:', event);
                    hasJoinedSuccessfully = true;
                    showSuccess('🎥 ¡Estás en la videollamada! Puedes activar cámara y micrófono');
                });

                jitsiApi.addEventListener('videoConferenceLeft', (event) => {
                    console.log('👋 Evento: Saliste de la videollamada', event);
                    // Solo salir si fue por acción del usuario (no por permisos de cámara/mic)
                    if (hasJoinedSuccessfully) {
                        leaveCall(true);
                    } else {
                        console.log('🔄 Ignorando salida automática - el usuario no se había unido completamente');
                    }
                });

                jitsiApi.addEventListener('participantJoined', (event) => {
                    console.log('👥 Nuevo participante se unió:', event);
                    showSuccess(`👥 ${event.displayName} se unió a la videollamada`);
                });

                jitsiApi.addEventListener('participantLeft', (event) => {
                    console.log('👋 Participante salió:', event);
                });

                jitsiApi.addEventListener('readyToClose', () => {
                    console.log('🔄 Jitsi listo para cerrar');
                    if (hasJoinedSuccessfully) {
                        leaveCall(true);
                    }
                });

                // Event listeners adicionales para mejor debugging
                jitsiApi.addEventListener('cameraError', (error) => {
                    console.error('❌ Error de cámara:', error);
                    showError('⚠️ Error de cámara. Revisa permisos.');
                });

                jitsiApi.addEventListener('micError', (error) => {
                    console.error('❌ Error de micrófono:', error);
                    showError('⚠️ Error de micrófono. Revisa permisos.');
                });

                jitsiApi.addEventListener('audioMuteStatusChanged', (event) => {
                    console.log('🎤 Estado audio:', event.muted ? 'Silenciado' : 'Activado');
                });

                jitsiApi.addEventListener('videoMuteStatusChanged', (event) => {
                    console.log('📹 Estado video:', event.muted ? 'Desactivado' : 'Activado');
                });

                // Eventos adicionales para debugging de permisos
                jitsiApi.addEventListener('deviceListChanged', (event) => {
                    console.log('📱 Lista de dispositivos cambió:', event);
                });

                jitsiApi.addEventListener('cameraReady', () => {
                    console.log('📹 Cámara lista');
                });

                jitsiApi.addEventListener('micReady', () => {
                    console.log('🎤 Micrófono listo');
                });

            } catch (error) {
                console.error('❌ Error configurando Jitsi:', error);
                showError('❌ Error configurando la videollamada: ' + error.message);
            }
        }

        // Funciones de UI
        function showUserControls() {
            document.getElementById('create-call-group').style.display = 'block';
            document.getElementById('join-call-group').style.display = 'block';
            document.getElementById('my-calls-group').style.display = 'block';
            document.getElementById('active-call-controls').style.display = 'none';
        }

        function showActiveCallControls() {
            document.getElementById('create-call-group').style.display = 'none';
            document.getElementById('join-call-group').style.display = 'none';
            document.getElementById('active-call-controls').style.display = 'block';
        }

        function showLoading(message) {
            isLoading = true;
            const container = document.getElementById('jitsi-container');
            container.innerHTML = `<div><span class="loading"></span>${message}</div>`;
            
            // Deshabilitar botones
            const buttons = document.querySelectorAll('.button');
            buttons.forEach(btn => btn.disabled = true);
        }

        function hideLoading() {
            isLoading = false;
            
            // Habilitar botones
            const buttons = document.querySelectorAll('.button');
            buttons.forEach(btn => btn.disabled = false);
            
            if (!currentCall) {
                const container = document.getElementById('jitsi-container');
                container.innerHTML = 'Crear o unirse a una videollamada para comenzar';
            }
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function showSuccess(message) {
            const container = document.getElementById('success-container');
            container.innerHTML = `<div class="success">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        function updateCallInfo(callData) {
            const container = document.getElementById('call-info-container');
            const statusClass = `status-${callData.status}`;
            
            container.innerHTML = `
                <div class="call-info">
                    <h4>📊 Información de la Videollamada</h4>
                    <p><strong>ID:</strong> ${callData.id}</p>
                    <p><strong>Sala:</strong> ${callData.jitsi_room_name}</p>
                    <p><strong>Estado:</strong> <span class="status-indicator ${statusClass}">${callData.status}</span></p>
                    <p><strong>Creada:</strong> ${new Date(callData.created_at).toLocaleString()}</p>
                    ${callData.scheduled_for ? `<p><strong>Programada para:</strong> ${new Date(callData.scheduled_for).toLocaleString()}</p>` : ''}
                </div>
            `;
        }

        function clearCallInfo() {
            document.getElementById('call-info-container').innerHTML = '';
        }

        function displayMyCalls(calls) {
            const container = document.getElementById('my-calls-list');
            
            if (calls.length === 0) {
                container.innerHTML = '<p>No tienes videollamadas registradas</p>';
                return;
            }

            container.innerHTML = calls.map(call => {
                const videoCall = call.video_calls;
                const statusClass = `status-${videoCall.status}`;
                
                return `
                    <div class="call-item" onclick="joinCallById('${videoCall.id}')">
                        <h5>${videoCall.jitsi_room_name}</h5>
                        <p><strong>Estado:</strong> <span class="status-indicator ${statusClass}">${videoCall.status}</span></p>
                        <p><strong>Te uniste:</strong> ${new Date(call.joined_at).toLocaleString()}</p>
                        ${call.left_at ? `<p><strong>Saliste:</strong> ${new Date(call.left_at).toLocaleString()}</p>` : ''}
                        ${call.duration_minutes ? `<p><strong>Duración:</strong> ${call.duration_minutes} minutos</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateDebugInfo() {
            document.getElementById('debug-user').textContent = currentUser.name || '-';
            document.getElementById('debug-token').textContent = currentUser.token ? 'SET' : '-';
            document.getElementById('debug-call').textContent = currentCall?.jitsi_room_name || '-';
            document.getElementById('debug-status').textContent = currentCall?.status || 'Desconectado';
        }

        function disconnect() {
            if (jitsiApi) {
                jitsiApi.dispose();
                jitsiApi = null;
            }
            
            currentUser = {
                supabase: null,
                token: null,
                userId: null,
                email: null,
                name: null
            };
            currentCall = null;
            
            // Resetear UI
            document.getElementById('user-info').textContent = 'Selecciona un usuario para comenzar';
            document.getElementById('create-call-group').style.display = 'none';
            document.getElementById('join-call-group').style.display = 'none';
            document.getElementById('my-calls-group').style.display = 'none';
            document.getElementById('active-call-controls').style.display = 'none';
            clearCallInfo();
            updateDebugInfo();
            
            const container = document.getElementById('jitsi-container');
            container.innerHTML = 'Selecciona un usuario y crea o únete a una videollamada para comenzar';
            
            showSuccess('✅ Usuario desconectado');
        }

        // Inicialización
        console.log(`
🎥 TEST VIDEOLLAMADAS JITSI - INSTRUCCIONES ACTUALIZADAS:

1. 👤 Selecciona un usuario (Rodrigo Salvador o Rodrigo Lopez)
2. 🎥 Crea una nueva videollamada (se activa INMEDIATAMENTE)
3. 📋 Copia el ID y compártelo con otros usuarios
4. 📡 O usa "Ver Salas Activas" para unirte a salas existentes
5. 🎮 ¡Disfruta de la videollamada en tiempo real!

✨ NOVEDADES:
- Las salas se crean como ACTIVAS (no scheduled)
- Cualquiera puede ver y unirse a salas activas
- Botón para copiar ID al portapapeles
- Lista de salas activas disponibles

🔧 CONFIGURACIÓN ACTUAL:
- Classroom API: ${CLASSROOM_API}
- Supabase URL: ${SUPABASE_URL}
        `);

        // Verificar servicios
        fetch(`${CLASSROOM_API}`)
            .then(response => response.text())
            .then(text => {
                console.log('✅ Classroom Service está disponible');
                showSuccess('✅ Classroom Service conectado');
            })
            .catch(error => {
                console.error('❌ Classroom Service NO está disponible:', error);
                showError('⚠️ IMPORTANTE: El Classroom Service no está disponible en http://localhost:3002');
            });
    </script>
</body>

</html>
